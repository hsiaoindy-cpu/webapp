<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>超慢跑機WEB APP模擬</title>
  <style>
    body { 
      font-family: system-ui, -apple-system, "Noto Sans TC", sans-serif; 
      padding: 20px; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      min-height: 100vh;
      margin: 0;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
      background: rgba(255,255,255,0.1);
      padding: 30px;
      border-radius: 15px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    }
    
    h1, h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 2em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    h2 {
      font-size: 1.5em;
      margin-top: 30px;
    }
    
    button { 
      padding: 12px 20px; 
      font-size: 16px; 
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 15px;
    }
    
    #connectBtn {
      background: #4CAF50;
      color: white;
    }
    
    #connectBtn:hover {
      background: #45a049;
      transform: translateY(-2px);
    }
    
    #connectBtn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    #handshakeBtn, #stopBtn, #speedBtn, #slowBtn {
      background: #2196F3;
      color: white;
    }
    
    #handshakeBtn:hover, #stopBtn:hover, #speedBtn:hover, #slowBtn:hover {
      background: #1976D2;
    }
    
    #downloadBtn {
      background: #FF9800;
      color: white;
    }
    
    #downloadBtn:hover {
      background: #F57C00;
      transform: translateY(-2px);
    }
    
    #downloadBtn:disabled {
      background: #666;
      cursor: not-allowed;
      transform: none;
    }
    
    .data-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px 0;
    }
    
    .data-card {
      background: rgba(255,255,255,0.2);
      padding: 20px;
      border-radius: 10px;
      text-align: center;
    }
    
    .data-value {
      font-size: 2.5em;
      font-weight: bold;
      margin: 10px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .data-label {
      font-size: 1.1em;
      opacity: 0.9;
    }
    
    .data-unit {
      font-size: 0.8em;
      opacity: 0.7;
    }
    
    .recording-status {
      background: rgba(255, 152, 0, 0.3);
      border: 2px solid #FF9800;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0% { opacity: 0.7; }
      50% { opacity: 1; }
      100% { opacity: 0.7; }
    }
    
    pre { 
      background: rgba(0,0,0,0.7); 
      color: #00ff00; 
      padding: 15px; 
      border-radius: 8px; 
      white-space: pre-wrap; 
      max-height: 300px;
      overflow-y: auto;
      font-size: 14px;
      margin-top: 20px;
      display: none;
    }
    
    .status {
      text-align: center;
      margin: 15px 0;
      padding: 10px;
      border-radius: 5px;
    }
    
    .status.connected {
      background: rgba(76, 175, 80, 0.3);
    }
    
    .status.disconnected {
      background: rgba(244, 67, 54, 0.3);
    }
    
    .controls {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin: 20px 0;
    }
    
    .download-section {
      margin-top: 20px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 10px;
    }
    
    .music-control {
      background: rgba(255,255,255,0.1);
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }
    
    .music-control .row { 
      display: flex;
      align-items: center;
      margin: 10px 0;
      gap: 10px;
    }
    
    .music-control input[type=range] { 
      flex: 1;
    }
    
    .music-control button {
      margin-bottom: 0;
    }
    
    .angle-speed-indicator {
      background: rgba(76, 175, 80, 0.3);
      border: 2px solid #4CAF50;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
      margin: 15px 0;
      font-size: 1.1em;
    }
    
    footer { 
      text-align: center;
      font-size: 0.9em;
      opacity: 0.7;
      margin-top: 15px;
    }
    
    @media (max-width: 600px) {
      .data-display {
        grid-template-columns: 1fr;
      }
      .controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>WEB APP連線測試</h1>
    
    <button id="connectBtn">🔗 連接超慢跑機</button>
    
    <div class="status disconnected" id="status">
      ⭕ 未連接
    </div>
    
    <div class="controls">
      <button id="handshakeBtn" disabled>🤝 開始傳輸</button>
      <button id="stopBtn" disabled>⏹️ 停止傳輸</button>
      <button id="speedBtn" disabled>🏃 增加速度</button>
      <button id="slowBtn" disabled>🏃 降低速度</button>
    </div>
    
    <div id="recordingStatus" style="display: none;" class="recording-status">
      🔴 記錄中... 已記錄 <span id="recordCount">0</span> 筆資料
    </div>
    
    <div class="data-display">
      <div class="data-card">
        <div class="data-label">心率</div>
        <div class="data-value" id="heartRate">--</div>
        <div class="data-unit">BPM</div>
      </div>
      <div class="data-card">
        <div class="data-label">踏板角度</div>
        <div class="data-value" id="tiltAngle">--</div>
        <div class="data-unit">度</div>
      </div>
    </div>
    
    <div class="data-display">
      <div class="data-card">
        <div class="data-label">封包序號</div>
        <div class="data-value" id="packetSeq">--</div>
        <div class="data-unit">No.</div>
      </div>
      <div class="data-card">
        <div class="data-label">接收次數</div>
        <div class="data-value" id="packetCount">0</div>
        <div class="data-unit">次</div>
      </div>
    </div>
    
    <div class="download-section">
      <button id="downloadBtn" disabled>💾 下載 JSON 記錄</button>
      <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;">
        將下載包含開始/停止時間及原始資料的 JSON 檔案
      </div>
    </div>
    
    <!-- Music Section -->
    <section id="music-section" class="music-control">
      <h2>音樂播放控制</h2>
      
      <div id="angleSpeedIndicator" class="angle-speed-indicator" style="display: none;">
        🎵 自動播放速率：<span id="autoSpeedValue">1.00</span>x
        <br>
        <small>步頻：<span id="angleForSpeed">-- </span> SPM | 狀態：<span id="motionState">等待中</span></small>
      </div>
      
      <div class="row">
        <button id="btnPlay">▶️ Start</button>
        <button id="btnStop" disabled>⏹️ Stop</button>
        <span>狀態：<span id="audioStatus">尚未載入音檔</span></span>
      </div>

      <div class="row">
        <label>基礎倍率 <span id="rateVal">1.00</span>x</label>
        <input id="rate" type="range" min="0.25" max="2.0" step="0.01" value="1.00">
      </div>

      <div class="row">
        <label>音量 <span id="gainVal">0.80</span></label>
        <input id="gain" type="range" min="0" max="1" step="0.01" value="0.8">
      </div>

      <div class="row">
        <label><input id="loop" type="checkbox" checked> 循環播放</label>
        <input id="file" type="file" accept="audio/*">
      </div>

      <div class="row">
        <label><input id="enableAngleControl" type="checkbox" checked> 啟用步頻控制速度</label>
      </div>

      <p style="font-size:0.9em;opacity:0.8;">
        BLE 傳入踏板角度會自動計算步頻，並改變播放速率
        <br>
        步頻計算：偵測角度上升/下降方向變化來識別峰值
        <br>
        <small>30 SPM (4秒2步) = 1.0x | 60 SPM (2秒2步) = 2.0x | 15 SPM (8秒2步) = 0.5x</small>
        <br>
        <small style="color:#ffeb3b;">⚠️ 角度資料每50ms更新，但變化很慢，需持續踏步1-2秒後才能準確計算步頻</small>
      </p>
    </section>

    <pre id="log"></pre>
    <footer>本系統示範 BLE 感測資料與 WebAudio 音樂互動</footer>
  </div>

  <script>
    // ==================== 全域變數 ====================
    let device = null;
    let server = null;
    let service = null;
    let characteristic = null;
    let isTransmitting = false;
    let packetCount = 0;
    let currentSpeedMode = 'SLOW';
    
    // 記錄相關變數
    let currentSession = null;
    let isRecording = false;
    
    // AMB82 BLE 服務 UUID
    const SERVICE_UUID = '12345678-1234-5678-9abc-123456789abc';
    const CHARACTERISTIC_UUID = '87654321-4321-8765-cba9-987654321cba';
    
    // WebAudio 變數
    let ctx, gainNode, source, buffer;
    let baseRate = 1.0, loop = true;
    let playing = false;
    let enableAngleControl = true;
    let currentTiltAngle = 0;
    
    // 步頻計算相關變數
    let angleHistory = []; // 保存所有角度歷史 {angle, timestamp}
    let stepTimestamps = []; // 記錄步伐時間點
    let lastPeakTime = 0;
    let lastPeakType = null; // 'min' 或 'max'
    
    const LOW_ANGLE = -5;      // 理論最低點
    const HIGH_ANGLE = 45;     // 理論最高點
    const MID_ANGLE = 20;      // 中間角度
    
    const ANGLE_HISTORY_DURATION = 10000; // 保留 10 秒的角度歷史
    const MIN_PEAK_INTERVAL = 300; // 兩個峰值之間的最小間隔（毫秒）
    const PEAK_DETECTION_WINDOW = 1000; // 峰值偵測窗口（1秒）
    const STEP_HISTORY_MAX = 10; // 保留最近幾步的時間記錄
    const CADENCE_CALC_WINDOW = 4; // 用最近幾步來計算步頻
    const SPEED_UPDATE_INTERVAL = 3000; // 每3秒更新一次播放速率
    
    let currentState = 'unknown'; // 'rising', 'falling', 'unknown'
    let lastStateChangeTime = 0;
    let lastSpeedUpdateTime = 0; // 上次更新播放速率的時間
    
    const $ = sel => document.querySelector(sel);
    const setAudioStatus = t => $("#audioStatus").textContent = t;
    
    // ==================== 步頻計算函數 ====================
    
    // 添加角度到歷史記錄
    const addAngleToHistory = (angle, timestamp) => {
      angleHistory.push({ angle, timestamp });
      
      // 清理超過保留時間的資料
      const cutoffTime = timestamp - ANGLE_HISTORY_DURATION;
      angleHistory = angleHistory.filter(item => item.timestamp > cutoffTime);
    };
    
    // 在指定時間窗口內找到最大/最小角度
    const findPeakInWindow = (centerTime, windowMs, type = 'max') => {
      const startTime = centerTime - windowMs / 2;
      const endTime = centerTime + windowMs / 2;
      
      const windowData = angleHistory.filter(
        item => item.timestamp >= startTime && item.timestamp <= endTime
      );
      
      if (windowData.length === 0) return null;
      
      if (type === 'max') {
        return windowData.reduce((max, item) => 
          item.angle > max.angle ? item : max
        );
      } else {
        return windowData.reduce((min, item) => 
          item.angle < min.angle ? item : min
        );
      }
    };
    
    // 判斷當前運動方向
    const detectMotionDirection = (angle, timestamp) => {
      if (angleHistory.length < 10) return 'unknown'; // 需要足夠的歷史資料
      
      // 取最近 1 秒的資料
      const recentData = angleHistory.filter(
        item => timestamp - item.timestamp <= 1000
      );
      
      if (recentData.length < 5) return currentState;
      
      // 計算角度變化趨勢（線性回歸的簡化版本）
      const firstHalf = recentData.slice(0, Math.floor(recentData.length / 2));
      const secondHalf = recentData.slice(Math.floor(recentData.length / 2));
      
      const avgFirst = firstHalf.reduce((sum, item) => sum + item.angle, 0) / firstHalf.length;
      const avgSecond = secondHalf.reduce((sum, item) => sum + item.angle, 0) / secondHalf.length;
      
      const diff = avgSecond - avgFirst;
      
      if (Math.abs(diff) < 1) return currentState; // 變化太小，保持當前狀態
      
      return diff > 0 ? 'rising' : 'falling';
    };
    
    // 偵測峰值（最高點或最低點）
    const detectPeak = (angle, timestamp) => {
      // 添加到歷史記錄
      addAngleToHistory(angle, timestamp);
      
      // 需要足夠的歷史資料才能開始偵測
      if (angleHistory.length < 20) {
        $("#motionState").textContent = "收集資料中...";
        return false; // 至少 1 秒的資料
      }
      
      // 防止過於頻繁的峰值偵測
      if (timestamp - lastPeakTime < MIN_PEAK_INTERVAL) {
        return false;
      }
      
      // 判斷當前運動方向
      const newDirection = detectMotionDirection(angle, timestamp);
      const directionChanged = (newDirection !== currentState && 
                               newDirection !== 'unknown' && 
                               currentState !== 'unknown');
      
      if (directionChanged) {
        log(`📊 方向變化: ${currentState} → ${newDirection}, 角度: ${angle.toFixed(1)}°`);
      }
      
      const prevState = currentState;
      currentState = newDirection;
      
      // 更新狀態顯示
      if (currentState === 'rising') {
        $("#motionState").textContent = "上升中 ↗";
      } else if (currentState === 'falling') {
        $("#motionState").textContent = "下降中 ↘";
      }
      
      // 方向轉變時才可能出現峰值
      if (!directionChanged) return false;
      
      let peakType = null;
      
      // 從上升轉為下降 = 可能到達最高點
      if (prevState === 'rising' && newDirection === 'falling') {
        // 在轉折點附近找最大值
        const peak = findPeakInWindow(timestamp, PEAK_DETECTION_WINDOW, 'max');
        
        if (peak && peak.angle > MID_ANGLE && lastPeakType !== 'max') {
          peakType = 'max';
          log(`👣 偵測到最高點 - 角度: ${peak.angle.toFixed(1)}°, 時間: ${new Date(peak.timestamp).toLocaleTimeString()}.${peak.timestamp % 1000}`);
        }
      }
      
      // 從下降轉為上升 = 可能到達最低點
      if (prevState === 'falling' && newDirection === 'rising') {
        // 在轉折點附近找最小值
        const peak = findPeakInWindow(timestamp, PEAK_DETECTION_WINDOW, 'min');
        
        if (peak && peak.angle < MID_ANGLE && lastPeakType !== 'min') {
          peakType = 'min';
          log(`👣 偵測到最低點 - 角度: ${peak.angle.toFixed(1)}°, 時間: ${new Date(peak.timestamp).toLocaleTimeString()}.${peak.timestamp % 1000}`);
        }
      }
      
      if (peakType) {
        lastPeakType = peakType;
        lastPeakTime = timestamp;
        lastStateChangeTime = timestamp;
        stepTimestamps.push(timestamp);
        
        // 只保留最近的步數記錄
        if (stepTimestamps.length > STEP_HISTORY_MAX) {
          stepTimestamps.shift();
        }
        
        return true;
      }
      
      return false;
    };
    
    // 計算步頻（steps per minute, SPM）
    const calculateCadence = () => {
      if (stepTimestamps.length < 2) return null;
      
      // 使用最近幾步計算平均步頻
      const recentSteps = Math.min(CADENCE_CALC_WINDOW, stepTimestamps.length);
      const startTime = stepTimestamps[stepTimestamps.length - recentSteps];
      const endTime = stepTimestamps[stepTimestamps.length - 1];
      const timeSpan = (endTime - startTime) / 1000; // 轉換為秒
      
      if (timeSpan === 0) return null;
      
      // 計算步頻（步/分鐘）
      const stepsInSpan = recentSteps - 1;
      const spm = (stepsInSpan / timeSpan) * 60;
      
      return spm;
    };
    
    // 將步頻轉換為播放速率
    const cadenceToPlaybackRate = (spm) => {
      if (!spm || spm <= 0) return 1.0;
      
      // 線性映射：15 SPM -> 0.5x, 30 SPM -> 1.0x, 60 SPM -> 2.0x
      // const rate = (spm / 30);
      const rate = (spm / 10);
      
      return Math.max(0.5, Math.min(2.0, rate));
    };
    
    // 更新音樂播放速率
    const updatePlaybackRateFromAngle = (angle) => {
      if (!enableAngleControl || !source || !playing) {
        return;
      }
      
      currentTiltAngle = angle;
      
      // 偵測步伐
      const timestamp = Date.now();
      const stepDetected = detectPeak(angle, timestamp);
      
      // 計算步頻
      const cadence = calculateCadence();
      
      if (cadence) {
        const newRate = cadenceToPlaybackRate(cadence);
        
        // 平滑過渡到新速率
        source.playbackRate.setTargetAtTime(newRate, ctx.currentTime, 0.2);
        
        // 更新顯示
        $("#autoSpeedValue").textContent = newRate.toFixed(2);
        $("#angleForSpeed").textContent = `${cadence.toFixed(1)}`;
        $("#angleSpeedIndicator").style.display = "block";
        
        if (stepDetected) {
          log(`🎵 步頻 ${cadence.toFixed(1)} SPM → 播放速率 ${newRate.toFixed(2)}x`);
        }
      } else if (stepTimestamps.length === 1) {
        // 只偵測到第一步，顯示提示
        $("#angleSpeedIndicator").style.display = "block";
        $("#autoSpeedValue").textContent = baseRate.toFixed(2);
        $("#angleForSpeed").textContent = "等待中";
        if (stepDetected) {
          log('👣 已偵測到第一步，請繼續踏步以計算步頻');
        }
      }
    };
    
    // ==================== 通用工具函數 ====================
    
    // 日誌函數
    const log = (...args) => {
      const timestamp = new Date().toLocaleTimeString();
      document.getElementById('log').textContent += `[${timestamp}] ${args.join(' ')}\n`;
      document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
      console.log(...args);
    };
    
    // 更新狀態顯示
    const updateStatus = (text, connected = false) => {
      const statusElement = document.getElementById('status');
      statusElement.textContent = text;
      statusElement.className = connected ? 'status connected' : 'status disconnected';
    };
    
    // 啟用/停用控制按鈕
    const updateButtons = (connected) => {
      document.getElementById('handshakeBtn').disabled = !connected;
      document.getElementById('stopBtn').disabled = !connected || !isTransmitting;
      document.getElementById('speedBtn').disabled = !connected;
      document.getElementById('slowBtn').disabled = !connected;
      document.getElementById('connectBtn').disabled = connected;
      document.getElementById('downloadBtn').disabled = !currentSession || isRecording;
    };
    
    // ==================== 資料記錄函數 ====================
    
    // 開始新的記錄會話
    const startRecordingSession = () => {
      currentSession = {
        startTime: new Date().toISOString(),
        stopTime: null,
        deviceInfo: {
          deviceName: device?.name || 'Unknown Device',
          deviceId: device?.id || 'Unknown ID'
        },
        rawData: []
      };
      isRecording = true;
      
      document.getElementById('recordingStatus').style.display = 'block';
      document.getElementById('recordCount').textContent = '0';
      
      log('📝 開始記錄會話:', currentSession.startTime);
    };
    
    // 停止記錄會話
    const stopRecordingSession = () => {
      if (currentSession && isRecording) {
        currentSession.stopTime = new Date().toISOString();
        isRecording = false;
        
        document.getElementById('recordingStatus').style.display = 'none';
        
        log('🏁 記錄會話結束:', currentSession.stopTime);
        log(`📊 本次記錄共 ${currentSession.rawData.length} 筆資料`);
        
        updateButtons(true);
      }
    };
    
    // 添加資料到當前記錄會話
    const addDataToSession = (rawPacket) => {
      if (currentSession && isRecording) {
        currentSession.rawData.push({
          timestamp: new Date().toISOString(),
          rawPacket: rawPacket
        });
        
        document.getElementById('recordCount').textContent = currentSession.rawData.length.toString();
      }
    };
    
    // 下載 JSON 檔案
    const downloadJSON = () => {
      if (!currentSession) {
        log('❌ 沒有可下載的記錄');
        return;
      }
      
      const startTime = new Date(currentSession.startTime);
      const fileName = `jogger_data_${startTime.getFullYear()}${(startTime.getMonth()+1).toString().padStart(2,'0')}${startTime.getDate().toString().padStart(2,'0')}_${startTime.getHours().toString().padStart(2,'0')}${startTime.getMinutes().toString().padStart(2,'0')}${startTime.getSeconds().toString().padStart(2,'0')}.json`;
      
      const jsonData = JSON.stringify(currentSession, null, 2);
      
      const blob = new Blob([jsonData], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = fileName;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      log('💾 JSON 檔案已下載:', fileName);
      log(`📁 檔案包含 ${currentSession.rawData.length} 筆記錄`);
    };
    
    // ==================== BLE 通訊函數 ====================
    
    // 解析資料封包
    const parseDataPacket = (data) => {
      try {
        const text = new TextDecoder().decode(data);
        
        const match = text.match(/<(\d)(\d{3})([+-]\d{3})>/);
        if (match) {
          const sequence = parseInt(match[1]);
          const heartRate = parseInt(match[2]);
          const tiltAngle = parseInt(match[3]) / 10.0;
          const rawPacket = match[0];
          
          document.getElementById('packetSeq').textContent = sequence;
          document.getElementById('heartRate').textContent = heartRate;
          document.getElementById('tiltAngle').textContent = tiltAngle.toFixed(1);
          document.getElementById('packetCount').textContent = ++packetCount;
          
          addDataToSession(rawPacket);
          
          // 根據角度更新音樂播放速率
          updatePlaybackRateFromAngle(tiltAngle);
          
          return true;
        } else {
          log('⚠️ 非標準封包格式:', text);
          return false;
        }
      } catch (error) {
        log('❌ 解析錯誤:', error.message);
        return false;
      }
    };
    
    // 發送命令到 AMB82
    const sendCommand = async (command) => {
      if (!characteristic) {
        log('❌ 特徵值未初始化');
        return false;
      }
      
      try {
        log('📤 發送命令:', command);
        const encoder = new TextEncoder();
        const data = encoder.encode(command);
        await characteristic.writeValue(data);
        return true;
      } catch (error) {
        log('❌ 發送命令失敗:', error.message);
        return false;
      }
    };
    
    // ==================== 事件監聽器 ====================
    
    // 連接設備
    document.getElementById('connectBtn').addEventListener('click', async () => {
      try {
        if (!navigator.bluetooth) {
          log('❌ 此瀏覽器不支援 Web Bluetooth API');
          return;
        }
        
        log('🔍 搜尋超慢跑機...');
        updateStatus('🔍 搜尋設備中...');
        
        device = await navigator.bluetooth.requestDevice({
          filters: [
            { name: 'AMB82-YL-Device' },
            { namePrefix: 'AMB82' }
          ],
          optionalServices: [SERVICE_UUID]
        });
        
        log('✅ 已選擇設備:', device.name || '(無名稱)');
        
        updateStatus('🔗 連接中...');
        server = await device.gatt.connect();
        log('🔗 已連接 GATT 伺服器');
        
        service = await server.getPrimaryService(SERVICE_UUID);
        log('🔧 已獲取服務');
        
        characteristic = await service.getCharacteristic(CHARACTERISTIC_UUID);
        log('📡 已獲取特徵值');
        
        await characteristic.startNotifications();
        log('🔔 已啟用通知');
        
        characteristic.addEventListener('characteristicvaluechanged', (event) => {
          parseDataPacket(event.target.value);
        });
        
        device.addEventListener('gattserverdisconnected', () => {
          log('🔌 設備已斷線');
          updateStatus('⭕ 設備斷線');
          updateButtons(false);
          isTransmitting = false;
          
          if (isRecording) {
            stopRecordingSession();
          }
        });
        
        updateStatus('✅ 已連接', true);
        updateButtons(true);
        log('🎉 連接成功！可以開始傳輸了');
        
      } catch (error) {
        log('❌ 連接失敗:', error.message);
        updateStatus('❌ 連接失敗');
        updateButtons(false);
      }
    });
    
    // 傳輸開始
    document.getElementById('handshakeBtn').addEventListener('click', async () => {
      if (await sendCommand('<HELLOYL>\n\r')) {
        log('🤝 發送傳輸命令，等待回應...');
        isTransmitting = true;
        
        startRecordingSession();
        
        updateButtons(true);
        updateStatus('📡 資料傳輸中', true);
      }
    });
    
    // 停止傳輸
    document.getElementById('stopBtn').addEventListener('click', async () => {
      if (await sendCommand('<BYEYL>\n\r')) {
        log('⏹️ 發送停止命令');
        isTransmitting = false;
        
        stopRecordingSession();
        
        updateButtons(true);
        updateStatus('⏸️ 傳輸已停止', true);
      }
    });
    
    // 增加速度
    document.getElementById('speedBtn').addEventListener('click', async () => {
      const nextMode = 'FAST';
      if (await sendCommand(nextMode)) {
        currentSpeedMode = nextMode;
        log(`🚀 切換到 ${currentSpeedMode} 模式`);
      }
    });

    // 降低速度
    document.getElementById('slowBtn').addEventListener('click', async () => {
      const nextMode = 'SLOW';
      if (await sendCommand(nextMode)) {
        currentSpeedMode = nextMode;
        log(`🚀 切換到 ${currentSpeedMode} 模式`);
      }
    });    
    
    // 下載按鈕事件
    document.getElementById('downloadBtn').addEventListener('click', () => {
      downloadJSON();
    });
    
    // ==================== WebAudio 音樂播放 ====================
    
    async function ensureCtx() {
      if (!ctx) {
        ctx = new (window.AudioContext || window.webkitAudioContext)();
        gainNode = ctx.createGain();
        gainNode.gain.value = 0.8;
        gainNode.connect(ctx.destination);
      }
      if (ctx.state === "suspended") await ctx.resume();
    }

    async function decodeFile(file) {
      await ensureCtx();
      const arr = await file.arrayBuffer();
      buffer = await ctx.decodeAudioData(arr);
      setAudioStatus(`已載入 ${file.name} (${buffer.duration.toFixed(1)}s)`);
    }

    function startPlay() {
      if (!buffer) return setAudioStatus("尚未載入音檔");
      stopPlay();
      source = ctx.createBufferSource();
      source.buffer = buffer;
      source.loop = loop;
      
      // 使用基礎速率作為初始速率
      source.playbackRate.value = baseRate;
      
      source.connect(gainNode);
      source.start();
      playing = true;
      $("#btnPlay").disabled = true;
      $("#btnStop").disabled = false;
      setAudioStatus("播放中…");
      
      if (enableAngleControl) {
        $("#angleSpeedIndicator").style.display = "block";
        log('🎵 音樂播放已啟動，將根據步頻自動調整速率');
        log('💡 請開始踏步，系統會在偵測到步伐後調整速率');
      }
    }

    function stopPlay() {
      if (source) { 
        try { source.stop(); } catch(e){} 
        source.disconnect(); 
        source = null; 
      }
      playing = false;
      $("#btnPlay").disabled = false;
      $("#btnStop").disabled = true;
      $("#angleSpeedIndicator").style.display = "none";
      setAudioStatus("停止播放");
    }

    $("#btnPlay").addEventListener("click", startPlay);
    $("#btnStop").addEventListener("click", stopPlay);
    
    $("#file").addEventListener("change", async e => {
      const f = e.target.files[0]; 
      if (f) { 
        await decodeFile(f); 
        startPlay(); 
      }
    });
    
    $("#rate").addEventListener("input", e => {
      baseRate = parseFloat(e.target.value);
      $("#rateVal").textContent = baseRate.toFixed(2);
      
      // 如果沒有啟用角度控制，直接更新播放速率
      if (source && !enableAngleControl) {
        source.playbackRate.setTargetAtTime(baseRate, ctx.currentTime, 0.05);
      }
    });
    
    $("#gain").addEventListener("input", e => {
      const g = parseFloat(e.target.value);
      $("#gainVal").textContent = g.toFixed(2);
      if (gainNode) gainNode.gain.setTargetAtTime(g, ctx.currentTime, 0.05);
    });
    
    $("#loop").addEventListener("change", e => loop = e.target.checked);
    
    $("#enableAngleControl").addEventListener("change", e => {
      enableAngleControl = e.target.checked;
      
      if (enableAngleControl) {
        log('✅ 啟用步頻控制播放速率');
        if (playing) {
          // 重置步頻計算
          stepTimestamps = [];
          lastPeakType = null;
          lastPeakTime = 0;
          angleHistory = [];
          currentState = 'unknown';
          lastStateChangeTime = 0;
        }
      } else {
        log('❌ 停用步頻控制播放速率，使用基礎倍率');
        $("#angleSpeedIndicator").style.display = "none";
        if (source && playing) {
          source.playbackRate.setTargetAtTime(baseRate, ctx.currentTime, 0.1);
        }
      }
    });
    
    // ==================== 初始化 ====================
    
    const initApp = async () => {
      log('🚀 AMB82 心跳角度監測系統已啟動（步頻偵測優化版）');
      log('💡 功能說明：');
      log('   • 點擊「開始傳輸」會自動開始記錄資料');
      log('   • 點擊「停止傳輸」會停止記錄並可下載 JSON');
      log('   • JSON 檔案包含開始/結束時間及原始封包資料');
      log('   • 系統會分析角度變化趨勢偵測峰值（最高點/最低點）');
      log('   • 步頻 15~60 SPM 對應速率 0.5x ~ 2.0x');
      log('   • 基準：30 SPM (4秒2步) = 1.0x');
      log('   • ⚠️ 角度更新頻繁但變化慢，需持續踏步1-2秒才能計算步頻');
      updateStatus('📱 請先連接設備');
    };
    
    // 啟動應用
    initApp();
    
  </script>
</body>
</html>